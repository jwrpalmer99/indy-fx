<form class="indy-fx-shader-library" style="max-height: 85vh; overflow-y: auto; padding-right: 0.25rem;">
  <details>
    <summary><strong>Import From ShaderToy with API key</strong></summary>
    <div class="form-group">
      <label>ShaderToy URL or ID</label>
      <div class="form-fields">
        <input type="text" name="importUrl" placeholder="https://www.shadertoy.com/view/llK3Dy" />
      </div>
    </div>
    <div class="form-group">
      <label>ShaderToy API key</label>
      <div class="form-fields">
        <input type="text" name="importApiKey" placeholder="ShaderToy API key" />
        <button type="button" data-action="import-url-shader">
          <i class="fas fa-cloud-download-alt"></i> Import From URL
        </button>
      </div>
      <p class="notes">Without a key, use the Import ShaderToy JSON section.</p>
    </div>
  </details>

  <details>
    <summary><strong>Import ShaderToy JSON (No Key)</strong></summary>
    <div class="form-group">
      <label>ShaderToy JSON payload</label>
      <div class="form-fields">
        <textarea name="importShaderToyJson" rows="10" placeholder='Paste JSON from ShaderToy API/export (object containing "Shader" or "renderpass")'></textarea>
      </div>
      <p class="notes"><button type="button" data-action="copy-shadertoy-json-script" class="indy-fx-link-button" style="all: unset; color: var(--color-text-hyperlink, #4aa3ff); cursor: pointer; text-decoration: underline;">Click on this text to copy js code and paste it in dev console on shadertoy.com, then paste result back in the JSON entry window here.</button></p>
    </div>
    <div class="form-group">
      <div class="form-fields">
        <button type="button" data-action="import-json-shader">
          <i class="fas fa-file-import"></i> Import JSON
        </button>
      </div>
    </div>
  </details>

  <details>
    <summary><strong>Manually Add ShaderToy Shader</strong></summary>
    <div class="form-group">
      <label>Shader Name</label>
      <div class="form-fields">
        <input type="text" name="importName" placeholder="My Shader Preset" />
      </div>
    </div>
    <div class="form-group">
      <label>Shader Label</label>
      <div class="form-fields">
        <input type="text" name="importLabel" placeholder="Display label (optional)" />
      </div>
    </div>
    <div class="form-group">
      <label>ShaderToy Fragment Source</label>
      <div class="form-fields">
        <textarea name="importSource" rows="14" placeholder="Paste ShaderToy fragment code with void mainImage(out vec4 fragColor, in vec2 fragCoord)"></textarea>
      </div>
    </div>

    <div class="form-group">
      <label>Auto-assign scene capture</label>
      <div class="form-fields">
        <input type="checkbox" name="autoAssignCapture" checked />
      </div>
      <p class="notes">If enabled, referenced channels default to clipped scene capture unless manually overridden below.</p>
    </div>

    <h3>Channel Assignments</h3>
    {{#each channelFields}}
    <div class="form-group" data-channel-row>
      <label>iChannel{{index}}</label>
      <div class="form-fields">
        <select name="{{modeName}}" data-channel-mode>
          {{#each modeOptions}}
          <option value="{{value}}" {{#if selected}}selected{{/if}}>{{label}}</option>
          {{/each}}
        </select>
        <input type="text" name="{{pathName}}" data-channel-path placeholder="Image path (for Custom image mode)" />
        <button type="button" data-action="pick-image" data-target="{{pathName}}">
          <i class="fas fa-file-import"></i> Browse
        </button>
      </div>
      <div class="form-fields">
        <textarea name="{{sourceName}}" data-channel-source rows="5" placeholder="Buffer source (for ShaderToy buffer code mode)"></textarea>
      </div>
    </div>
    {{/each}}

    <footer class="sheet-footer flexrow">
      <button type="submit">Import Shader</button>
    </footer>
  </details>

  <details open>
    <summary><strong>Imported Shaders</strong></summary>
    <div class="form-group" style="margin-top:0.35rem;">
      <div class="form-fields">
        <button type="button" data-action="export-shader-library"><i class="fas fa-file-export"></i> Export</button>
        <button type="button" data-action="import-shader-library"><i class="fas fa-file-import"></i> Import</button>
        <input type="file" name="importShaderLibraryFile" accept=".json,application/json" style="display:none;" />
      </div>
    </div>
    <div class="form-group" style="margin-top:0.35rem;">
      <div class="form-fields" style="display:flex;align-items:center;flex-wrap:nowrap;gap:0.4rem;width:100%;">
        <label style="margin:0;flex:0 0 auto;">Search</label>
        <input type="text" name="shaderSearch" data-action="shader-search" value="{{searchTerm}}" placeholder="Filter by shader name or label" style="flex:1 1 auto;min-width:0;" />
        <div style="display:inline-flex;flex:0 0 auto;gap:0.25rem;align-items:center;white-space:nowrap;margin-left:auto;">
          <button
            type="button"
            data-action="shader-view-toggle"
            data-view-mode="compact"
            title="Compact cards (no hover preview)"
            aria-label="Compact view"
            style="min-width:2rem;padding:0.2rem 0.35rem;{{#if isCompactView}}background:rgba(80,160,255,0.22);border-color:rgba(80,160,255,0.75);{{/if}}"
          ><i class="fas fa-grip-lines"></i></button>
          <button
            type="button"
            data-action="shader-view-toggle"
            data-view-mode="standard"
            title="Standard cards (hover preview)"
            aria-label="Standard view"
            style="min-width:2rem;padding:0.2rem 0.35rem;{{#if isStandardView}}background:rgba(80,160,255,0.22);border-color:rgba(80,160,255,0.75);{{/if}}"
          ><i class="fas fa-th-large"></i></button>
        </div>
      </div>
    </div>
    {{#if imported.length}}
    <div class="indy-fx-shader-grid" data-shader-grid style="margin-top:0.35rem;display:grid;grid-template-columns:{{#if isCompactView}}repeat(auto-fill,minmax(156px,156px)){{else}}repeat(auto-fill,minmax(160px,160px)){{/if}};justify-content:start;gap:{{#if isCompactView}}0.45rem{{else}}0.6rem{{/if}};">
      {{#each imported}}
      <article class="indy-fx-shader-card {{#if selected}}is-selected{{/if}}" data-shader-id="{{id}}" data-shader-name="{{name}}" data-shader-label="{{label}}" style="border:1px solid var(--color-border-light-primary,#666);border-radius:6px;overflow:hidden;cursor:pointer;background:rgba(0,0,0,0.08);{{#if selected}} box-shadow: 0 0 0 2px rgba(80,160,255,0.75) inset;{{/if}}">
        {{#if ../isCompactView}}
        <div style="padding:0.38rem 0.45rem;min-height:2.4rem;display:flex;align-items:center;gap:0.45rem;">
          <div data-thumb-stage style="position:relative;flex:0 0 32px;width:32px;height:32px;border-radius:4px;overflow:hidden;background:#111;background-image:url('modules/indy-fx/images/indyFX_solid.webp');background-size:cover;background-position:center;pointer-events:none;">
            <img data-thumb-image draggable="false" src="{{thumbnail}}" alt="{{label}}" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;pointer-events:none;user-select:none;-webkit-user-drag:none;{{#unless thumbnail}}display:none;{{/unless}}" />
            {{#unless thumbnail}}
            <div data-no-thumb style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#bbb;font-size:0.65rem;pointer-events:none;">-</div>
            {{/unless}}
          </div>
          <div style="min-width:0;display:flex;flex-direction:column;justify-content:center;">
            <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.15;">{{label}}</div>
            <div style="font-size:0.73rem;opacity:0.78;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.15;margin-top:0.08rem;">{{captureSummary}}</div>
          </div>
        </div>
        {{else}}
        <div data-thumb-stage style="position:relative;aspect-ratio:1/1;background:#111;background-image:url('modules/indy-fx/images/indyFX_solid.webp');background-size:cover;background-position:center;pointer-events:none;">
          <img data-thumb-image draggable="false" src="{{thumbnail}}" alt="{{label}}" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;pointer-events:none;user-select:none;-webkit-user-drag:none;{{#unless thumbnail}}display:none;{{/unless}}" />
          <canvas data-thumb-canvas width="256" height="256" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;"></canvas>
          {{#unless thumbnail}}
          <div data-no-thumb style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#bbb;font-size:0.85rem;pointer-events:none;">No thumbnail</div>
          {{/unless}}
        </div>
        <div style="padding:0.35rem 0.45rem;">
          <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">{{label}}</div>
          <div style="font-size:0.78rem;opacity:0.8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">{{id}}</div>
        </div>
        {{/if}}
      </article>
      {{/each}}
    </div>
    <p class="notes" data-search-empty style="display:none;">No imported shaders match the current search.</p>
    <p class="notes">Single-click selects as preset. Double-click edits. Right-click for actions.</p>
    {{else}}
    <p class="notes">No imported shaders yet.</p>
    {{/if}}
  </details>
</form>

